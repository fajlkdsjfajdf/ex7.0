{% extends "admin_base.html" %}

{% block title %}仪表盘{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-tachometer-alt"></i> 系统仪表盘</h1>
    <p class="page-subtitle">实时监控系统状态和任务运行情况</p>
</div>

<!-- 资源监控 -->
<section class="dashboard-section">
    <h2 class="section-title">
        <i class="fas fa-server"></i> 资源监控
    </h2>
    <div class="resource-grid">
        <div class="resource-card">
            <div class="resource-header">
                <i class="fas fa-microchip resource-icon cpu-icon"></i>
                <span class="resource-name">CPU 使用率</span>
            </div>
            <div class="resource-value">
                <span id="cpuValue">--</span>%
            </div>
            <div class="resource-bar">
                <div class="resource-progress" id="cpuBar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="resource-card">
            <div class="resource-header">
                <i class="fas fa-memory resource-icon memory-icon"></i>
                <span class="resource-name">内存使用率</span>
            </div>
            <div class="resource-value">
                <span id="memoryValue">--</span>%
            </div>
            <div class="resource-bar">
                <div class="resource-progress" id="memoryBar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
            </div>
            <div class="resource-detail">
                已用: <span id="memoryUsed">--</span> GB / 总计: <span id="memoryTotal">--</span> GB
            </div>
        </div>

        <div class="resource-card">
            <div class="resource-header">
                <i class="fas fa-hdd resource-icon disk-icon"></i>
                <span class="resource-name">磁盘使用率</span>
            </div>
            <div class="resource-value">
                <span id="diskValue">--</span>%
            </div>
            <div class="resource-bar">
                <div class="resource-progress" id="diskBar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
            </div>
            <div class="resource-detail">
                已用: <span id="diskUsed">--</span> GB / 总计: <span id="diskTotal">--</span> GB
            </div>
        </div>
    </div>
</section>

<!-- 四桶状态 -->
<section class="dashboard-section">
    <h2 class="section-title">
        <i class="fas fa-buckets"></i> 四桶状态
    </h2>
    <div class="bucket-grid">
        <div class="bucket-card high-speed">
            <div class="bucket-header">
                <i class="fas fa-bolt"></i>
                <h3>高速桶</h3>
            </div>
            <div class="bucket-stats">
                <div class="bucket-stat">
                    <span class="stat-label">待处理任务</span>
                    <span class="stat-value" id="highSpeedCount">--</span>
                </div>
                <div class="bucket-stat">
                    <span class="stat-label">容量限制</span>
                    <span class="stat-value" id="highSpeedMax">--</span>
                </div>
            </div>
            <div class="bucket-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="highSpeedProgress" style="width: 0%"></div>
                </div>
                <span class="progress-text" id="highSpeedPercent">0%</span>
            </div>
            <div class="bucket-footer">
                <span class="bucket-desc">高优先级任务队列</span>
                <div class="bucket-actions">
                    <button class="btn-view" onclick="viewBucket('high_speed')">
                        <i class="fas fa-eye"></i> 查看
                    </button>
                    <button class="btn-clear" onclick="clearBucket('high_speed')">
                        <i class="fas fa-trash"></i> 清空
                    </button>
                </div>
            </div>
        </div>

        <div class="bucket-card low-speed">
            <div class="bucket-header">
                <i class="fas fa-clock"></i>
                <h3>低速桶</h3>
            </div>
            <div class="bucket-stats">
                <div class="bucket-stat">
                    <span class="stat-label">批量任务</span>
                    <span class="stat-value" id="lowSpeedCount">--</span>
                </div>
                <div class="bucket-stat">
                    <span class="stat-label">容量限制</span>
                    <span class="stat-value" id="lowSpeedMax">--</span>
                </div>
            </div>
            <div class="bucket-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="lowSpeedProgress" style="width: 0%"></div>
                </div>
                <span class="progress-text" id="lowSpeedPercent">0%</span>
            </div>
            <div class="bucket-footer">
                <span class="bucket-desc">低优先级批量任务</span>
                <div class="bucket-actions">
                    <button class="btn-view" onclick="viewBucket('low_speed')">
                        <i class="fas fa-eye"></i> 查看
                    </button>
                    <button class="btn-clear" onclick="clearBucket('low_speed')">
                        <i class="fas fa-trash"></i> 清空
                    </button>
                </div>
            </div>
        </div>

        <div class="bucket-card processing">
            <div class="bucket-header">
                <i class="fas fa-cogs"></i>
                <h3>运行中</h3>
            </div>
            <div class="bucket-stats">
                <div class="bucket-stat">
                    <span class="stat-label">正在执行</span>
                    <span class="stat-value" id="processingCount">--</span>
                </div>
                <div class="bucket-stat">
                    <span class="stat-label">最大并发</span>
                    <span class="stat-value" id="processingMax">--</span>
                </div>
            </div>
            <div class="bucket-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="processingProgress" style="width: 0%"></div>
                </div>
                <span class="progress-text" id="processingPercent">0%</span>
            </div>
            <div class="bucket-footer">
                <span class="bucket-desc">正在爬取的任务</span>
                <div class="bucket-actions">
                    <button class="btn-view" onclick="viewBucket('processing')">
                        <i class="fas fa-eye"></i> 查看
                    </button>
                </div>
            </div>
        </div>

        <div class="bucket-card result">
            <div class="bucket-header">
                <i class="fas fa-check-circle"></i>
                <h3>结果桶</h3>
            </div>
            <div class="bucket-stats">
                <div class="bucket-stat">
                    <span class="stat-label">执行记录</span>
                    <span class="stat-value" id="resultCount">--</span>
                </div>
                <div class="bucket-stat">
                    <span class="stat-label">容量限制</span>
                    <span class="stat-value" id="resultMax">--</span>
                </div>
            </div>
            <div class="bucket-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="resultProgress" style="width: 0%"></div>
                </div>
                <span class="progress-text" id="resultPercent">0%</span>
            </div>
            <div class="bucket-footer">
                <span class="bucket-desc">已完成任务记录</span>
                <div class="bucket-actions">
                    <button class="btn-view" onclick="viewBucket('result')">
                        <i class="fas fa-eye"></i> 查看
                    </button>
                    <button class="btn-clear" onclick="clearBucket('result')">
                        <i class="fas fa-trash"></i> 清空
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- 站点定时任务 -->
<section class="dashboard-section">
    <h2 class="section-title">
        <i class="fas fa-clock"></i> 站点定时任务
        <button class="btn-refresh" onclick="loadSiteSchedulerStatus()">
            <i class="fas fa-sync-alt"></i> 刷新
        </button>
    </h2>

    <div id="siteSchedulerContent">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i> 加载中...
        </div>
    </div>
</section>

<!-- 桶任务列表弹窗 -->
<div id="bucketTasksModal" class="modal">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
            <h2 id="bucketTasksModalTitle">桶任务列表</h2>
            <button class="modal-close" onclick="closeBucketTasksModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="tasks-table-container">
                <table class="tasks-table">
                    <thead>
                        <tr>
                            <th>任务ID</th>
                            <th>类型</th>
                            <th>优先级</th>
                            <th>站点</th>
                            <th>添加时间</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="bucketTasksTableBody">
                        <tr>
                            <td colspan="7" class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>暂无任务</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeBucketTasksModal()">
                <i class="fas fa-times"></i> 关闭
            </button>
        </div>
    </div>
</div>

<!-- 任务详情弹窗 -->
<div id="taskDetailModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2>任务详情</h2>
            <button class="modal-close" onclick="closeTaskDetailModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="taskDetailContent">
                <!-- 详情内容将通过JavaScript填充 -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeTaskDetailModal()">
                <i class="fas fa-times"></i> 关闭
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="/static/common/js/utils.js"></script>
<script src="/static/common/js/admin-dashboard.js"></script>
{% endblock %}
